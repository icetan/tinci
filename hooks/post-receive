#!/bin/bash
TINCIV=6.1.0

HOOK="$(pwd)/hooks/tinci"
PREHOOK="$(pwd)/hooks/tinci-pre"
LOGDIR="$(pwd)/.tinci"
mkdir -p "$LOGDIR"

TDIR=$(mktemp -d "${TMPDIR:-/tmp}"/tinci.XXXXXXXX)
mkdir -p $TDIR
trap "trap - EXIT; rm -rf $TDIR" EXIT

while read OLDSHA NEWSHA REF ; do

  [ "$NEWSHA" != "0000000000000000000000000000000000000000" ] || continue

  CMD="$(git archive $NEWSHA | tar -t | grep '^.tinci$')"
  [ "$CMD" ] || continue

  INPUT="$OLDSHA $NEWSHA $REF"
  LOGFILE="$LOGDIR/$NEWSHA.log"
  PLOGFILE="$LOGDIR/$OLDSHA.log"
  WDIR=$TDIR/$NEWSHA
  mkdir -p $WDIR

  git archive $NEWSHA | tar -x -C $WDIR

  [ -f $PLOGFILE ] && PSTAT=$(tail -n1 $PLOGFILE | sed -nE 's/^# code ([0-9]+)$/\1/p')
  [ ! "$PSTAT" ] && PSTAT=0

  [ -x "$PREHOOK" ] && echo $INPUT | sh "$PREHOOK" $PSTAT $WDIR 2>&1

  ( cd $WDIR
    echo -e "# tinci $TINCIV\n# ref $REF\n# running sh $CMD"
    sh "$CMD" 2>&1
    echo "# code $?"
  ) | tee "$LOGFILE"

  STAT=$(tail -n1 "$LOGFILE" | sed -nE 's/^# code ([0-9]+)$/\1/p')
  [ ! "$STAT" ] && STAT=-1

  [ -x "$HOOK" ] && echo $INPUT | sh "$HOOK" $STAT $WDIR 2>&1

  if [ $STAT -eq 0 ]; then
    [ $PSTAT -eq 0 ] && echo -e "\nJob successful!" || echo -e "\nJob fixed!"
  else
    [ $PSTAT -eq 0 ] && echo -e >&2 "\nJob failed!" || echo -e >&2 "\nJob is still failing!"
  fi
done
