#!/bin/sh
VERSION=0.0.3

BRANCH=$(git config --get tinci.branch)
[ -n "$BRANCH" ] || BRANCH=master

read INPUT
REF=$(echo "$INPUT" | cut -d ' ' -f 3)
[ -n "$(echo "$REF" | grep -E "^refs/heads/($BRANCH)$")" ] || exit
BRANCH=$(echo "$REF" | cut -d '/' -f 3)

CMD=$(git config --get tinci.runner)
SUCCESS=hooks/tinci-success
FAIL=hooks/tinci-fail
DIR=job.$RANDOM
mkdir -p .tinci
cd .tinci
PREVSTAT=$(tail -n1 `ls -1t | head -n1`)
[ -n "$PREVSTAT" ] || PREVSTAT=0
git clone .. -b "$BRANCH" $DIR > /dev/null
cd $DIR
LOGFILE=../$(git rev-parse HEAD).log
echo "=== tinci (v$VERSION) is running '$CMD' ===" | tee $LOGFILE
{ eval "$CMD" 2>&1; echo "Job exited with code:\n$?"; } | tee -a $LOGFILE
if [ $(tail -n1 $LOGFILE) -eq 0 ];then
  [ $PREVSTAT -eq 0 ] && echo "Job successful!" || echo "Job fixed!"
  (cd ../..; [ -f "$SUCCESS" ] && echo "$INPUT" | exec "$SUCCESS" $PREVSTATE 2>&1)
else
  [ $PREVSTAT -eq 0 ] && echo >&2 "Job failed!" || echo >&2 "Job is still failing!"
  (cd ../..; [ -f "$FAIL" ] && echo "$INPUT" | exec "$FAIL" $PREVSTAT 2>&1)
fi
cd ..
rm -rf $DIR
